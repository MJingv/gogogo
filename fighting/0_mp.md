微信小程序
---

# 双线程架构

- 逻辑层和渲染层分成2个独立的线程，两者通过jsbridge通信
- iOS：jscore+webkit，android：腾讯x5
- jsbridge作用：通信、api调用原生能力
- 逻辑层
    - 提供app和page方法作为小程序的页面入口
    - 提供微信api使用原生能力
    - 实现模块化能力
    - 提供数据绑定、事件分发、生命周期管理、路由管理等
- 渲染层
    - *渲染和更新dom*
    - 使用exparser库实现小程序渲染的基础能力和组件
    - 将wxml转成vdom，通过虚拟dom对比前后获取最新dom并更新
    - 内置基础组件，原生组件和webview

- 优势
    - 提高用户体验，避免长时间阻塞
    - 并发处理，更好的应对复杂业务逻辑和大量数据操作
    - 高效利用资源，发挥多核处理器优势
    - 数据隔离，限制数据交互，减少被篡改的风险
- 劣势
    - 线程同步问题
    - 内存增加
    - 调试和排查

# 运行机制

- 首次打开小程序or手动刷新小程序会进行*冷启动*，冷启动时微信客户端会去远程cdn下载小程序包并进行小程序加载
- 小程序冷启动会执行逻辑层完整生命周期，如onload
- 小程序关闭时会被切换至后台，在一段时间未使用or内存不足才会被销毁
- 当短时间二次打开，会执行小程序*热启动*，直接将后台小程序切换到前台运行
- 只有热启动会onshow

# 渲染流程

- 初次渲染，ui和data层都初始化，ui层加载html/css/js并完成js编译，data层分别在框架和业务逻辑的js编译
- data计算首屏的dom并初始化数据进行序列化后通过jsbridge给ui层
- ui层拿到数据后反序列化，执行vdom的patch操作并进行页面渲染
- data层在生命周期or事件监听进行逻辑处理，将新数据通过setdata给ui层
- ui层拿到新数据再次进行patch和渲染